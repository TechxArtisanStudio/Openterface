<!--
  Copyright (c) 2016-2024 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine current locale -->
{% set current_locale = page.locale or config.theme.language or (page.url.split('/')[1] if page.url and page.url.split('/')[1] in ['de', 'es', 'fr', 'it', 'ja', 'ko', 'pt', 'ro', 'zh'] else 'en') %}

<!-- Determine cookies -->
{% set cookies = config.extra.consent.cookies | d({}) %}
{% if config.extra.analytics %}
  {% if "analytics" not in cookies %}
    {% set _ = cookies.update({ "analytics": "Google Analytics" }) %}
  {% endif %}
{% endif %}
{% if config.repo_url and "github.com" in config.repo_url %}
  {% if "github" not in cookies %}
    {% set _ = cookies.update({ "github": "GitHub" }) %}
  {% endif %}
{% endif %}

<!-- Determine actions -->
{% set actions = config.extra.consent.actions %}
{% if not actions %}
  {% set actions = ["accept", "manage"] %}
{% endif %}

<!-- Determine initial settings state -->
{% if "manage" not in actions %}
  {% set checked = "checked" %}
{% endif %}

<!-- Language tabs -->
<div class="md-consent__lang-tabs" id="consent-lang-tabs">
  <button type="button" class="lang-tab" data-lang="en" data-url="/">English</button>
  <button type="button" class="lang-tab" data-lang="zh" data-url="/zh/">中文</button>
  <button type="button" class="lang-tab" data-lang="ja" data-url="/ja/">日本語</button>
  <button type="button" class="lang-tab" data-lang="ko" data-url="/ko/">한국어</button>
  <button type="button" class="lang-tab" data-lang="fr" data-url="/fr/">Français</button>
  <button type="button" class="lang-tab" data-lang="de" data-url="/de/">Deutsch</button>
  <button type="button" class="lang-tab" data-lang="it" data-url="/it/">Italiano</button>
  <button type="button" class="lang-tab" data-lang="es" data-url="/es/">Español</button>
  <button type="button" class="lang-tab" data-lang="pt" data-url="/pt/">Português</button>
  <button type="button" class="lang-tab" data-lang="ro" data-url="/ro/">Română</button>
</div>

<!-- Consent content container -->
<div id="consent-content-container">
  <!-- Consent title and description with language-specific content -->
  <div class="consent-content" data-lang="en">
    <h4>Cookie Consent</h4>
    <p>We use cookies to enhance quality of docs content, analyse site effectiveness and needs. By consenting, you help us improve our website. Thanks!</p>
  </div>
  <div class="consent-content" data-lang="de" style="display: none;">
    <h4>Cookie-Einwilligung</h4>
    <p>Wir verwenden Cookies, um die Qualität des Dokumentationsinhalts zu verbessern, die Website-Effektivität zu analysieren und Bedürfnisse zu ermitteln. Durch Ihre Zustimmung helfen Sie uns, unsere Website zu verbessern. Vielen Dank!</p>
  </div>
  <div class="consent-content" data-lang="es" style="display: none;">
    <h4>Consentimiento de Cookies</h4>
    <p>Utilizamos cookies para mejorar la calidad del contenido de la documentación, analizar la efectividad del sitio y las necesidades. Al dar su consentimiento, nos ayuda a mejorar nuestro sitio web. ¡Gracias!</p>
  </div>
  <div class="consent-content" data-lang="fr" style="display: none;">
    <h4>Consentement aux Cookies</h4>
    <p>Nous utilisons des cookies pour améliorer la qualité du contenu de la documentation, analyser l'efficacité du site et les besoins. En donnant votre consentement, vous nous aidez à améliorer notre site web. Merci !</p>
  </div>
  <div class="consent-content" data-lang="it" style="display: none;">
    <h4>Consenso sui Cookie</h4>
    <p>Utilizziamo i cookie per migliorare la qualità del contenuto della documentazione, analizzare l'efficacia del sito e le esigenze. Dando il tuo consenso, ci aiuti a migliorare il nostro sito web. Grazie!</p>
  </div>
  <div class="consent-content" data-lang="ja" style="display: none;">
    <h4>クッキー同意</h4>
    <p>ドキュメントコンテンツの品質向上、サイトの効果性とニーズの分析にクッキーを使用しています。同意することで、私たちのウェブサイトの改善にご協力いただいています。ありがとうございます！</p>
  </div>
  <div class="consent-content" data-lang="ko" style="display: none;">
    <h4>쿠키 동의</h4>
    <p>문서 콘텐츠의 품질 향상, 사이트 효과성 및 요구사항 분석을 위해 쿠키를 사용합니다. 동의해 주시면 웹사이트 개선에 도움이 됩니다. 감사합니다!</p>
  </div>
  <div class="consent-content" data-lang="pt" style="display: none;">
    <h4>Consentimento de Cookies</h4>
    <p>Usamos cookies para melhorar a qualidade do conteúdo da documentação, analisar a eficácia do site e as necessidades. Ao dar seu consentimento, você nos ajuda a melhorar nosso site. Obrigado!</p>
  </div>
  <div class="consent-content" data-lang="zh" style="display: none;">
    <h4>Cookie 同意</h4>
    <p>我们使用 cookie 来提升文档内容质量，分析网站效果和需求。通过同意，您帮助我们改善网站。谢谢！</p>
  </div>
  <div class="consent-content" data-lang="ro" style="display: none;">
    <h4>Consimțământ Cookie</h4>
    <p>Folosim cookie-uri pentru a îmbunătăți calitatea conținutului documentației, pentru a analiza eficacitatea site-ului și nevoile. Prin consimțământul dumneavoastră, ne ajutați să îmbunătățim site-ul nostru. Mulțumim!</p>
  </div>
</div>

<!-- Consent settings -->
<input
  class="md-toggle"
  type="checkbox"
  id="__settings"
  {{ checked }}
/>
<div class="md-consent__settings">
  <ul class="task-list">
    {% for type in cookies %}
      {% set checked = "" %}
      {% if cookies[type] is string %}
        {% set name = cookies[type] %}
        {% set checked = "checked" %}
      {% else %}
        {% set name = cookies[type].name %}
        {% if cookies[type].checked %}
          {% set checked = "checked" %}
        {% endif %}
      {% endif %}
      <li class="task-list-item" data-cookie-type="{{ type }}">
        <label class="task-list-control">
          <input type="checkbox" name="{{ type }}" {{ checked }}>
          <span class="task-list-indicator"></span>
          <span class="cookie-name">{{ name }}</span>
        </label>
      </li>
    {% endfor %}
  </ul>
</div>

<!-- Consent controls -->
<div class="md-consent__controls">
  {% for action in actions %}

    <!-- Button to accept cookies -->
    {% if action == "accept" %}
      <button type="button" class="md-button md-button--primary" id="consent-accept-btn">
        <span class="btn-text-accept">{{- lang.t("consent.accept") -}}</span>
      </button>
    {% endif %}

    <!-- Button to reject cookies -->
    {% if action == "reject" %}
      <button type="reset" class="md-button" id="consent-reject-btn">
        <span class="btn-text-reject">{{- lang.t("consent.reject") -}}</span>
      </button>
    {% endif %}

    <!-- Button to manage settings -->
    {% if action == "manage" %}
      <label class="md-button" for="__settings" id="consent-manage-btn">
        <span class="btn-text-manage">{{- lang.t("consent.manage") -}}</span>
      </label>
    {% endif %}
  {% endfor %}
</div>

<script>
(function() {
  'use strict';
  
  // Translation mappings
  const translations = {
    'en': {
      cookies: {
        'analytics': 'Google Analytics',
        'github': 'GitHub'
      },
      buttons: {
        accept: 'Accept',
        reject: 'Reject',
        manage: 'Manage'
      }
    },
    'de': {
      cookies: {
        'analytics': 'Google Analytics',
        'github': 'GitHub'
      },
      buttons: {
        accept: 'Akzeptieren',
        reject: 'Ablehnen',
        manage: 'Verwalten'
      }
    },
    'es': {
      cookies: {
        'analytics': 'Google Analytics',
        'github': 'GitHub'
      },
      buttons: {
        accept: 'Aceptar',
        reject: 'Rechazar',
        manage: 'Gestionar'
      }
    },
    'fr': {
      cookies: {
        'analytics': 'Google Analytics',
        'github': 'GitHub'
      },
      buttons: {
        accept: 'Accepter',
        reject: 'Refuser',
        manage: 'Gérer'
      }
    },
    'it': {
      cookies: {
        'analytics': 'Google Analytics',
        'github': 'GitHub'
      },
      buttons: {
        accept: 'Accetta',
        reject: 'Rifiuta',
        manage: 'Gestisci'
      }
    },
    'ja': {
      cookies: {
        'analytics': 'Google Analytics',
        'github': 'GitHub'
      },
      buttons: {
        accept: '同意する',
        reject: '拒否する',
        manage: '設定'
      }
    },
    'ko': {
      cookies: {
        'analytics': 'Google Analytics',
        'github': 'GitHub'
      },
      buttons: {
        accept: '수락',
        reject: '거부',
        manage: '관리'
      }
    },
    'pt': {
      cookies: {
        'analytics': 'Google Analytics',
        'github': 'GitHub'
      },
      buttons: {
        accept: 'Aceitar',
        reject: 'Rejeitar',
        manage: 'Gerenciar'
      }
    },
    'zh': {
      cookies: {
        'analytics': 'Google Analytics',
        'github': 'GitHub'
      },
      buttons: {
        accept: '接受',
        reject: '拒绝',
        manage: '管理'
      }
    },
    'ro': {
      cookies: {
        'analytics': 'Google Analytics',
        'github': 'GitHub'
      },
      buttons: {
        accept: 'Accept',
        reject: 'Respinge',
        manage: 'Gestionează'
      }
    }
  };
  
  // Detect current language from URL
  function getCurrentLang() {
    const path = window.location.pathname;
    const segments = path.split('/').filter(segment => segment);
    if (segments.length > 0 && ['de', 'es', 'fr', 'it', 'ja', 'ko', 'pt', 'zh', 'ro'].includes(segments[0])) {
      return segments[0];
    }
    return 'en';
  }

  // Build URL with selected language while preserving current path
  function buildLanguageUrl(selectedLang, currentPath) {
    const langCodes = ['de', 'es', 'fr', 'it', 'ja', 'ko', 'pt', 'zh', 'ro'];
    const segments = currentPath.split('/').filter(segment => segment);
    
    // Remove existing language prefix if present
    if (segments.length > 0 && langCodes.includes(segments[0])) {
      segments.shift();
    }
    
    // Build new path with selected language
    if (selectedLang === 'en') {
      // English is root, no prefix
      if (segments.length === 0) {
        return '/';
      }
      return '/' + segments.join('/') + '/';
    } else {
      // Other languages get prefix
      if (segments.length === 0) {
        return '/' + selectedLang + '/';
      }
      return '/' + selectedLang + '/' + segments.join('/') + '/';
    }
  }

  // Update all text content based on selected language
  function updateTextContent(lang) {
    const t = translations[lang] || translations['en'];
    
    // Update cookie names
    document.querySelectorAll('.task-list-item').forEach(item => {
      const cookieType = item.dataset.cookieType;
      const cookieNameSpan = item.querySelector('.cookie-name');
      if (cookieNameSpan && t.cookies[cookieType]) {
        cookieNameSpan.textContent = t.cookies[cookieType];
      }
    });
    
    // Update button texts
    const acceptBtn = document.querySelector('.btn-text-accept');
    const rejectBtn = document.querySelector('.btn-text-reject');
    const manageBtn = document.querySelector('.btn-text-manage');
    
    if (acceptBtn) acceptBtn.textContent = t.buttons.accept;
    if (rejectBtn) rejectBtn.textContent = t.buttons.reject;
    if (manageBtn) manageBtn.textContent = t.buttons.manage;
  }

  // Initialize on DOM ready
  document.addEventListener('DOMContentLoaded', function() {
    const consentDialog = document.querySelector('.md-consent');
    const storedConsent = localStorage.getItem('__md_consent');
    
    // Hide consent dialog if consent already exists
    if (storedConsent) {
      try {
        const parsed = JSON.parse(storedConsent);
        // Hide the dialog if consent exists
        if (consentDialog && Object.keys(parsed).length > 0) {
          consentDialog.style.display = 'none';
          consentDialog.setAttribute('hidden', '');
          consentDialog.setAttribute('data-md-state', '');
        }
      } catch(e) {
        // Ignore parse errors
      }
    }
    
    const langTabs = document.querySelectorAll('.lang-tab');
    const consentContents = document.querySelectorAll('.consent-content');
    const acceptBtn = document.getElementById('consent-accept-btn');
    const baseUrl = window.location.origin;
    
    // Set initial active language based on current page
    const currentLang = getCurrentLang();
    let selectedLang = currentLang;
    
    // Update active tab
    langTabs.forEach(tab => {
      if (tab.dataset.lang === currentLang) {
        tab.classList.add('active');
      } else {
        tab.classList.remove('active');
      }
    });
    
    // Show initial content
    consentContents.forEach(content => {
      if (content.dataset.lang === currentLang) {
        content.style.display = 'block';
      } else {
        content.style.display = 'none';
      }
    });
    
    // Update initial text content
    updateTextContent(currentLang);
    
    // Handle tab clicks
    langTabs.forEach(tab => {
      tab.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const lang = this.dataset.lang;
        
        // Update selected language
        selectedLang = lang;
        
        // Update active tab
        langTabs.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // Update content
        consentContents.forEach(content => {
          if (content.dataset.lang === lang) {
            content.style.display = 'block';
          } else {
            content.style.display = 'none';
          }
        });
        
        // Update all text content
        updateTextContent(lang);
      });
    });
    
    // Handle accept button click - redirect to selected language preserving path
    if (acceptBtn) {
      // Add listener after Material's handler (bubble phase, lower priority)
      acceptBtn.addEventListener('click', function(e) {
        // Get current path
        const currentPath = window.location.pathname;
        
        // Build URL with selected language while preserving current path
        const newUrl = buildLanguageUrl(selectedLang, currentPath);
        
        // Wait for Material's consent handler to complete, then redirect
        setTimeout(function() {
          // Double-check consent is stored (Material should have done this)
          const consentSettings = document.querySelector('.md-consent__settings');
          let consent = {};
          
          if (consentSettings) {
            const checkboxes = consentSettings.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
              consent[checkbox.name] = checkbox.checked;
            });
            // Ensure consent is stored
            localStorage.setItem('__md_consent', JSON.stringify(consent));
          }
          
          // Redirect to selected language URL
          window.location.href = baseUrl + newUrl;
        }, 100);
      }, false); // Bubble phase - runs after Material's handler
    }
    
    // Check if consent dialog is visible on load and hide if consent exists
    setTimeout(function() {
      const consentDialog = document.querySelector('.md-consent');
      const storedConsent = localStorage.getItem('__md_consent');
      
      // If consent exists but dialog is still visible, hide it
      if (consentDialog && storedConsent) {
        try {
          const parsed = JSON.parse(storedConsent);
          if (parsed && typeof parsed === 'object' && Object.keys(parsed).length > 0) {
            consentDialog.style.display = 'none';
            consentDialog.setAttribute('hidden', '');
            consentDialog.removeAttribute('data-md-state');
          }
        } catch(e) {
          // Ignore parse errors
        }
      }
    }, 500);
  });
})();
</script>